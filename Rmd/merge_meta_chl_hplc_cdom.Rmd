---
title: "Read All Meta for eDNA"
author: "Sebastian DiGeronimo"
date: '2022-09-13'
output: html_document
---

# TODO: format like merge_data.Rmd

```{r setup}
librarian::shelf(
  librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  # broom # optional
  
  # additional
  readxl
)

library("conflicted")

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

```


```{r find-files}
files <-
  dir_ls(here("data/metadata/WS_all/"),
         regexp  = "^[^~]*\\.(xlsx|csv)$",
         recurse = TRUE) %>%
  tibble(files = ., 
         base  = basename(.)) %>%

  # ignore some files
  filter(str_detect(basename(files), "fknms_") &
         !str_detect(files, "ignore"))

# files to be read
files$base
```

```{r}
file_info <- list()
# recal <- list()
recal <- data.frame(file = NA, temp_sht = NA, sht_name = NA, row = NA, last_c = NA)

for (i in seq(nrow(files))) {
  # for (i in 1:5) {
  
  # select sheet name with `field_logsheet`
  cli::cli_alert_info("Getting sheet info for file: {.file {files$base[i]}}")
  temp_sht <- excel_sheets(files$files[i]) 
  sht_name <- which(str_detect(temp_sht, "field_"))
  
  if (is_empty(sht_name)) {
    sht_name <- menu(temp_sht, 
                     title = glue(
                       "\n-----\n\n",
                       "Which sheet contains metadata?", 
                       "\n(0 for none)"))
  }
  
  # # ----
  # if (length(temp_sht[grepl("field_", temp_sht)]) > 0 ) {
  #   sht_name <- which(grepl("field_", temp_sht))
  # } else {
  #   print(temp_sht)
  #   sht_name <- readline("pick one of the sheets ") %>%
  #     as.numeric()
  # }
   
  
  # read sheet ----
  temp <- read_excel(files$files[i],
             # sheet = temp_sht[sht_name], 
             sheet = sht_name, 
             n_max = 5,
             col_names = FALSE,
             .name_repair = "unique_quiet") 
  
  print(temp)

  name <- files$files[i]
  
  row <- which(grepl("(?i)sample", temp), arr.ind = TRUE)[1]
  
  if (is.na(row)) {
    print(temp)
    Sys.sleep(1)
    row <- readline("which line is the header? ") %>%
      as.numeric()
    }
  
  # if (grepl("(?i)sample", temp[1,1])) {
  #    1
  # } else {
  #   row <- readline("which line is the header? ") %>%
  #   as.numeric()
  # } 
  # 

  
  if (is.na(row)) next
  
  # TODO: add end column number
  last_c <- which(grepl("(?i)notes", temp[row,])) 
  
  
  # file_info[[name]] <- as.character(temp[row,]) 
  
  recal[i,] <-  (cbind(file = files[i], temp_sht[sht_name], sht_name, row, last_c))
   
}
```

```{r}
na_skip <- c("NA", "Skipped", "skipped", "na", "n/a", "n./a", "n.a", "Flow", 
             stringi::stri_dup("-", 1:20))

header <- tibble(`names(temp)` = NA)
store <- list()
for (i in seq(files)) {
  temp <- read_xlsx(
    recal$file[i],
    sheet = recal$temp_sht[i],
    # n_max = 30,
    skip = as.numeric(recal$row[i]) - 1,
    .name_repair = janitor::make_clean_names,
    na = na_skip
  )   %>%
  select(1:recal$last_c[i] %>% as.numeric()) %>%

  select(-any_of(c("x", "wb", "ws", "x_2", "x_3", "x_4", "x_5",  "x_6",  "x_7", "x_8",
                   "x_9", "nov",
                   "x21338","x22022", "x22072",
                   "x22141", "x22215", "max_depth", "depth_m" )
                 )
         )  %>%
  mutate(
    across(where(is.character), ~ replace(., str_detect(., "--|\\*|Skipped"), NA)),
    vol_ml = replace(vol_ml,  str_detect(vol_ml, "-"), NA),
    vol_ml = str_replace_all(vol_ml, "~", "")
    ) %>%
      type_convert() %>%
    mutate(
      notes = as.character(notes)
    )
  
 
  if (basename(files[i]) == "fknms_sample_logsheet_OCT2017.xlsx") {
    temp %<>%
    mutate(vol_ml = strsplit(as.character(vol_ml), "&")) %>%
      unnest(vol_ml) %>%
      mutate(vol_ml = str_trim(vol_ml)) %>%
      type_convert()
  }

  if (basename(files[i]) == "fknms_logsheet_OCT2018.xlsx") temp %<>%
  rename("sample_collection_time_gmt" = time_gmt)
  
  if (basename(files[i]) == "fknms_sample_logsheet_07_08_2021.xlsx") temp %<>% 
    replace_na(list(depth_m = 1))

  
  store$fknms_sample_logsheet_07_08_2021.xlsx %>%
  replace_na(list(depth_m = 1))
  
  
  name <- basename(files[i])
  store[[name]] <- temp
  
  header <- bind_rows(header, as.data.frame(names(temp)))
  
}

merge_by <- header %>%
  group_by(`names(temp)`) %>%
summarise(count = n()) %>%
  filter(count > 32) %$% 
  `names(temp)`

mismatch <- t(janitor::compare_df_cols(store, 
                         return = "mismatch"))
                         
                         
                         
mismatch

# TODO: add log stuff here to fix mismatches
```
```{r}


# i = which(basename(files) == "fknms_sample_logsheet_12_2021.xlsx")
store$fknms_logsheet_OCT2018.xlsx



```

```{r}

store_merg <- reduce(store, full_join) %>%
  filter(date_mm_dd_yy != as_date("1899-12-31 00:00:00"))


store_merg %>%
  filter(!is.na(date_mm_dd_yy), !is.na(sample_collection_time_gmt)) %>%
  # filter(sample_type != "CDOM", is.na(vol_ml))
  group_by(sample_type) %>%
  distinct() %>%
  summarise(total = n())
  
test <- store_merg %>%
  filter(!is.na(date_mm_dd_yy), !is.na(sample_collection_time_gmt)) %>%
  # filter(sample_type != "CDOM", is.na(vol_ml))
  group_by(sample_type) %>%
  distinct()
# %>%
  # summarise(total = n())

store_merg %>% 
  # arrange(date_mm_dd_yy)
  filter(date_mm_dd_yy <= as_date("2019-07-19")) %>%
  group_by(sample_type) %>%
  
  summarise(n = n())



store_merg %>%
  filter(sample_type == "Chl-a", 
         !is.na(vol_ml),
         date_mm_dd_yy != as_date("1899-12-31 00:00:00")
         ) %>%
  distinct(identifier, .keep_all = T) %>%
  arrange(date_mm_dd_yy)

```

```{r}
source("../scripts/log_file_changes.R")
startup()
current_log()
log4r_info(verbose = FALSE)

read.delim("../data_change_logfile.txt")
```

