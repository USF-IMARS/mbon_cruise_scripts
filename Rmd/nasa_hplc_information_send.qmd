---
title: "NASA-HPLC Sample Info Send"
author: "Sebastian Di Geronimo"
date: "2023-05-02"
format: html
---

# Info:

This file is to load the cruise metadata for HPLC and input into the 
NASA-HPLC sample info before sending to Crystal Thomas at NASA for processing.



# Setup

## Load Libraries 
```{r setup}
if (!nzchar(system.file(package = "librarian"))) 
  install.packages("librarian")

librarian::shelf(
  librarian, conflicted, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  # broom # optional
  
  # additional
  openxlsx, hms
)

# shelf(conflicted) # may be needed if won't allow loading of certain packages

conflicts_prefer(
  dplyr::filter(), 
  dplyr::select()
  )
```

## ---- Edit: Info ----
```{r}
grant_info <-
  list(
  info = rbind(
    # grant name
    "The Southeast US Marine Biodiversity Observation Network (MBON): Toward Operational Marine Life Data for Conservation and Sustainability",
    # grant number
    "80NSSC22K1779",
    # contact
    "Sebastian Di Geronimo, sebastian15@usf.edu"
  ),
  
  # your last name
  last_nm = "Digeronimo"
  
  )
```

## File Paths
- Sample Info Template
- Cruise Metadata

```{r}
template <-
  here("data") %>%
  dir_ls(
  regexp      = "^[^~]*sampleinfo.*", 
  type        = "file",
  ignore.case = TRUE) %>%
  str_subset("ignore", negate = TRUE)

metadata <-
dir_ls(here(cloud_dir),
         regexp = "imars_inventory_chl_hplc_cdom") %>%
  read.xlsx(sheet = "sample_meta_data",
            detectDates = FALSE) %>%
  filter(str_detect(sample_type, "(?i)hplc")) %>%
  mutate(
    date = janitor::excel_numeric_to_date(date_mm_dd_yy),
    time = hms::as_hms(sample_collection_time_gmt),
    datetime = ymd_hms(glue("{date} {time}"), truncated = 3),
    station = str_remove(station, "\\.0$"),
    .before = date_mm_dd_yy
  )

cruise_id <- 
metadata %$% unique(cruise_id) %>%
  str_subset(str_c("W[SB]2[1-3]", "WS15264", "WS15320", sep = "|")) %>%
  str_subset(str_c("WS21093", "WS21032", sep = "|"), negate = T) 
  
metadata_filt <- 
  metadata %>%
  filter(str_detect(.data$cruise_id, str_c(.env$cruise_id, collapse = "|"))) 
```

```{r}
sheet_nm <- getSheetNames(template)

loc <-
  which(
    read.xlsx(
      template,
      sheet         = sheet_nm,
      colNames      = FALSE,
      skipEmptyRows = FALSE,
    ) == "PI",
    arr.ind = TRUE
  )

col_names <- 
read.xlsx(
  template,
  sheet         = sheet_nm,
  startRow      = loc[1],
  skipEmptyCols = FALSE
) %>%
  names()


grant_loc <-
  which(
    read.xlsx(
      template,
      sheet         = sheet_nm,
      colNames      = FALSE,
      skipEmptyCols = FALSE,
    ) == "Project:",
    arr.ind = TRUE
  )
```

hplc_gsfc_id
X2
PI
sample = identifier
cruise = cruise_id
indicate.if.filters.are.replicates
volfilt = vol_ml
station = station
bottle
depth = depth_m
water_depth
name.of.water.body
year
month
day
sdy
time
lon
lat
filter.type
filter.diameter.(mm)
filter.storage.before.shipment.to.GFC
other
other   


base
cruise_id
year
identifier
date_mm_dd_yy
station
lon
lat
sample_collection_time_gmt
date_time
depth_m
sample_type
vol_ml
notes
sample_number
collector
max_depth
```{r}
water_body <- list(
  "Florida Keys" = c(
    glue("{1:18}"),
    glue("9.{1:9}"), "9B", "24", "LK", "MR", "WS", "21.5"
  ),
  "Southwest Florida Shelf" = c(
    glue("{30:68}"),
    glue("57.{1:3}"), "KW1", "KW2", "KW4"
  ),
  "West Florda Shelf" = c(
    "Z04-068", "CBH", "NBH", "EB1",
    as.vector(outer(
      c("AMI", "V", "TB", "CW", "L", "GP", "RP", "ROME", "CAL", "BG"),
      c(1:12),
      str_c
    ))
  )
) %T>% print()
```

```{r}
metadata_filt
meta_format <-
  metadata_filt %>%
  mutate(
    .keep        = "none",
    .after       = 0,
    hplc_gsfc_id = NA_character_,
    X2           = NA_character_,
    PI           = "Muller-Karger, Frank",
    sample       = identifier,
    cruise       = cruise_id,
    indicate.if.filters.are.replicates = NA_character_,
    volfilt     = vol_ml,
    station,
    bottle      = -9999,
    depth       = depth_m,
    water_depth = max_depth,
    name.of.water.body = NA_character_,
    year        = year(date),
    month       = month(date, label = TRUE, abbr = TRUE),
    day         = day(date),
    sdy         = yday(date),
    time        = round_hms(time, digits = 0),
    time        = str_remove_all(time, ":"),
    lon,
    lat,
    filter.type = "GF/F",
    `filter.diameter.(mm)` = "25 mm",
    filter.storage.before.shipment.to.GFC = "-80C",
    # other,
    # other,
  ) %>%
  select(contains(col_names)) %>%
  mutate(
    .by = c(cruise, station, depth),
    indicate.if.filters.are.replicates = case_when(
      n() < 2 ~ "S",
      n() < 3 ~ "D",
      n() >= 3 ~ "T"
    )
  ) %>%
  mutate(
    name.of.water.body = case_match(
      station,
      water_body[[1]] ~ names(water_body)[1],
      water_body[[2]] ~ names(water_body)[2],
      water_body[[3]] ~ names(water_body)[3],
      .default = NA_character_
    ),
    depth = if_else(is.na(depth), 1, depth),
  ) %>%
  mutate(
    .by = station,
    water_depth = if_else(!is.na(water_depth), water_depth,
      median(water_depth, na.rm = TRUE)
    )
  ) %>%
  arrange(year, month, nchar(sample), sample) %T>%
  print()
```
```{r fig.height=15, fig.width=20}
(meta_format %>%
   # filter(station == "24" | station == "MR") %>%
  ggplot(aes(x = lon, y = lat, 
              group = station
             )) +
  geom_point(data = select(meta_format, -name.of.water.body),
             color = "gray80",
             shape = 3) +
  geom_point(aes(color = name.of.water.body)) + 
   facet_grid(~name.of.water.body)
  ) %>%
  plotly::ggplotly()
```

```{r}
naniar::vis_miss(meta_format)
```

```{r}
wb <- loadWorkbook(template)
names(wb)

writeData(
  wb,
  sheet    = 1,
  x        = grant_info$info,
  startRow = grant_loc[1],
  startCol = grant_loc[2] + 1,
  colNames = FALSE
)

writeData(wb, 
          sheet = 1,
          x = meta_format,
          startRow = loc[1] + 1,
          colNames = FALSE)

openXL(wb)


saveWorkbook(
  wb = wb,
  file = here(
    "data", "metadata",
    glue(
      grant_info$last_nm,
      format(Sys.Date(), "_%Y%m%d_"),
      str_c(cruise_id, collapse = "_"),
      ".xlsx"
    )
  )
)

```

