---
title: "Print Cruise"
author: "Sebastian DiGeronimo"
date: "2023-02-13"
output: html_document
---
# Info
This script will write files per cruise with following information:
- identifier	
- station	
- collection_date
- collected_by
- present 
- absent
- maybe

These files will be printed out and used to verify the location of the each 
filter pad sample prior to lab processing. It will also serve as the schedule
for the cruise processing only the odd numbered samples.

When verifying, 
present: sample was in correct bag when verifying, and split into even and odd 
         afterwards
missing: samples may not be present because were left in dewar, or written 
         improperly and will need to see if any duplicated samples are present
         and easily distinguished (usually hand writing). 
         You may need to unwrap the sample and read the histoprep capsule.
         It should be labeled as:
         - "missing" if no evidence of it exists
         - "found; not running" if sample was found later and not cold
         
maybe: if found two samples with same name and cannot be distinguished
       - "duplicate name; not running"

A sample may be present with the correct cruise ID, but not written on the 
sheet, this sample will need to be verified with the original log sheet.
Usually this occurs if no volume was recorded and may not be useful to process. 
It can be moved into the evens bag and labeled as:
- "present but not running" if no volume was recorded

# Load Librarys
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
librarian::shelf(
  librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  
  # additional
  # readxl, # decided openxlsx is better to create file
  openxlsx, cli, janitor
)

library("conflicted")

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

```{r vars}
# loads cloud directory in .Rprofile
source(here(".Rprofile"))


# change if another author
author <- "Sebastian Di Geronimo" 

# three sheets:
# 1. chl_progress
# 2. hplc_progress
# 3. cdom_progress
# "Chl-a"           "HPLC"            "CDOM"      
sht_num <- 3 # change here to 1, 2, 3
sht_nm  <-
  switch(
    sht_num,
    c("chl_progress", "Chl-a"),
    c("cdom_progress", "CDOM"),
    c("hplc_progress", "HPLC")
    )

local_sv <- here("data", "print", sht_nm[1])
dir_create(local_sv)


rm(sht_num)
```

```{r}

```


# Find Cruise Metadata 
This file is located in:
box > imars_imars_cruises > imars_inventory_chl_hplc_cdom_updated_<date>.xlsx

https://usf.app.box.com/folder/179388329770?s=f6kujckfibt78al222ied0w2m6dxa529
```{r load-meta-file}
meta <-
  dir_ls(here(cloud_dir),
         regexp = "imars_inventory_chl_hplc_cdom") %>%
  read.xlsx(sheet = "sample_meta_data") %>%
  mutate(collection_date = excel_numeric_to_date(date_mm_dd_yy)) %>%
  filter(
    str_detect(sample_type, sht_nm[2]) 
    & collection_date > as_date("2019-09-01")) %>%
  select(cruise_id, collection_date, station,
         collected_by = collector, 
         vol = vol_ml,
         identifier) %>%
  mutate(
    collection_date = format(collection_date, "%b %d, %Y"),
    
    # add fill in sections
    present = NA_character_,
    absent  = NA_character_,
    notes   = NA_character_
    ) 


cli_alert_info("Filtering by sample_type: {sht_nm[2]}")
slice_sample(meta, n = 2, by = cruise_id)
```

# Create Cruise Verification Sample Sheet
```{r load-create-wb}
# if need to start from scratch
scratch <- FALSE
scratch <- T

# find previously saved files
prev_f <- 
  local_sv %>%
  dir_ls(regexp = glue("^[^~]*{sht_nm[1]}.*\\.xlsx$")
         )

# select most recently saved
prev_f <-
  (file_info(prev_f) %>%
  arrange(desc(birth_time)))[1,1][[1]]

# if none, create,
# else read previous file
if (is.na(prev_f) | scratch) {
  cli_alert_info("Creating New Worksheet")
  wb <- 
  createWorkbook(
    author,
    "Filter Pad Presence/Absence"
    )
  } else {
    cli_alert_info("Loading Previous File: {basename(prev_f)}")
    wb <- 
      prev_f %>%
      loadWorkbook(.)
  }
```

```{r add-cruise-sheet}
for (cruise  in unique(meta$cruise_id)) {
  
  # ---- determine if cruise ID exists in previous file
  if (cruise %in% names(wb)) {
    cli_alert_warning("Skipping Cruise ID: {cruise}")
    next
  } 

  cli_alert_info("Adding Cruise ID: {cruise}")

  # ---- filter for cruise ID in meta
  temp_df <-
    meta %>%
    filter(cruise_id == {{cruise}}) %>%
    select(-cruise_id)
  
  # ---- add cruise sheet name
  addWorksheet(
    wb, 
    sheetName = cruise,
    gridLines = openxlsx_getOp("gridLines", TRUE)
    )
  
  # ---- add cruise info
  writeData(
    wb, 
    sheet    = cruise,
    x        = cbind(cruise, "Filter Pads"),
    colNames = FALSE
    )
  
  writeData(
    wb, 
    sheet    = cruise,
    x        = temp_df,
    startRow = 3,
    borders  = openxlsx_getOp("borders", "all"),
    headerStyle = createStyle(
      halign = "CENTER", textDecoration = "bold",
      border = "TopBottomLeftRight"
      )
    )
  
  # ---- set widths of columns 
  setColWidths(
    wb,
    sheet  = cruise,
    cols   = seq(temp_df),
    widths = "auto"
    )

  setColWidths(
    wb,
    sheet  = cruise,
    cols   = ncol(temp_df),
    widths = 42,
  )
 setColWidths(
    wb,
    sheet  = cruise,
    cols   = 4,
    widths = 7,
  )
 
  setColWidths(
    wb,
    sheet  = cruise,
    cols   = 5,
    widths = 13,
  )
  
  # ---- set page setup for printing 
  pageSetup(
    wb,
    sheet       = cruise, 
    orientation = "portrait",
    fitToWidth  = TRUE,
    left        = 0.25,
    right       = 0.25,
    top         = 0.25,
    bottom      = 0.25,
    printTitleRows = c(1:3)
    )
  
  freezePane(
    wb,
    sheet = cruise,
    firstActiveRow = 4,
    firstActiveCol = 1
    )
}


# openXL(wb)
```
# Save Workbook Locally
```{r local-wb-sv}
saveWorkbook(
  wb,
  file =  here(local_sv,
               glue("{sht_nm[1]}_pres_abs_updated_",
                    format(Sys.time(), "%Y%m%dT%H%M"),
                    ".xlsx")),
  overwrite = TRUE
  )

rm(wb, prev_f, meta)
```

# Save Workbook in Cloud
```{r cloud-wb-sv}
# TODO: set location
# loc <- here(cloud_dir, "")
# dir_create(loc)

if (!exists("loc")) {
  cli_alert_danger(c("You need to set {.var loc} before continuing if you ",
                   "want to copy file to cloud directory!"))
  # invisible(return(""))
  invisible(stop("\r       "))
} 

# find previously saved files
prev_f <-
  local_sv %>%
  dir_ls(regexp = glue("^[^~]*{sht_nm[1]}.*\\.xlsx$")
         )

# select most recently saved
prev_f <-
  (file_info(prev_f) %>%
  arrange(desc(birth_time)))[1,1][[1]]

if (is_empty(prev_f)) {
  cli_alert_info("No File to Copy")
  } else {
    cli_alert_info(c("Copying file: {basename(prev_f)}\n to cloud location: ",
                     "{.file {loc}}"))
    file_copy(prev_f, loc, TRUE)
  }
```
# OLD WAY CREATING csv in separate files
I opted for .xlsx because it would contain all cruises in one file with the 
correct formatting for printing each cruise
```{r create_file}
# ovt <- T
# dir_create(here("data", "print", "verified"))
# dir_create(here("data", "print", "unverified"))
# meta <-
#   dir_ls(here(cloud_dir), 
#          regexp = "imars_inventory_chl_hplc_cdom") %>%
#   
#   read_xlsx(sheet     = "chl_progress",
#             guess_max = 10000) %>%
#   
#   filter(collection_date > as_date("2019-09-01")) %>%
#   select(1, 2, 5, 6, 3)  %>%
#   mutate(
#     collection_date = format(collection_date, "%b %d, %Y"),
#     
#     present = NA_character_,
#     absent  = NA_character_,
#     notes   = NA_character_
#   )
# 
# for (i  in seq(unique(meta$cruise_id))) {
#   cruise    <- unique(meta$cruise_id)[i]
#   file_name <- here("data", "print", "unverified", glue("{cruise}_pres_abs.csv"))
#   
#   if (file_exists(file_name) & !ovt) {
#     cli_alert_warning("Skipping: {basename(file_name)}; already exists")
#     next
#   }
#   
#   cli_alert_info("Creating file: {basename(file_name)}")
#   sink(file_name)
# 
#   cat(paste(cruise, ",filter pads", "\n\n"))
# 
#   meta %>%
#   filter(cruise_id == {{cruise}}) %>%
#   select(-cruise_id) %>%
#   write.csv(., row.names = FALSE, na = "")
# 
#   sink()
# }

# shell.exec(here("data", "print", glue("{cruise}_pres_abs.csv")))
```
