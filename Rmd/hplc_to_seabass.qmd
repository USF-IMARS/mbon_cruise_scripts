---
title: "HPLC SeaBass Submission"
author: "Sebastian Di Geronimo"
date: '2023-03-13'
format: html
---
# 1.0 Information
## 1.1 Links: SeaBass Instructions for Submission of HPLC
Instructions: https://seabass.gsfc.nasa.gov/wiki/Data_Submission
Check before submit: https://seabass.gsfc.nasa.gov/wiki/FCHECK#Download%20Source%20Code

## 1.2 Header
https://seabass.gsfc.nasa.gov/wiki/metadataheaders

### 1.2.1 Required Fields:
investigators
affiliations
contact
experiment
cruise
station
data_file_name
documetns
data_type
calibration_files
start_date
end_date
start_time
end_time
north_latitude
south_latitude
east_longitude
west_longitude
water_depth
missing
delimiter
fields
units

### 1.2.2 Conditionally Required Headers


### 1.2.3 HPLC Specific
https://seabass.gsfc.nasa.gov/wiki/data_submission_special_requirements#Pigments,%20HPLC
/HPLC_lab (e.g., NASA_GSFC)
/HPLC_lab_technician (e.g., Crystal_Thomas)

### 1.2.4 Ex Header
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ start ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/begin_header	
/identifier_product_doi=10.5067/SeaBASS/EXPORTS/DATA001	
/received=20190807	
/affiliations=Bowdoin_College	
/investigators=Collin_Roesler	
/contact=croesler@bowdoin.edu	sdrapeau@bowdoin.edu
/experiment=EXPORTS	
/cruise=EXPORTSNP	
/data_file_name=EXPORTS_EXPORTSNP_HPLC-inline_survey_20180814.csv	
/original_file_name=EXPORTS_Roesler_08-06_report.xlsx	
/data_type=pigment	
/start_date=20180811	
/end_date=20180908	
/start_time=19:19:00[GMT]	
/end_time=19:44:00[GMT]	
/water_depth=na	
/measurement_depth=5.5	
/west_longitude=-145.960[DEG]	
/east_longitude=-131.543[DEG]	
/north_latitude=50.643[DEG]	
/south_latitude=49.4265[DEG]	
/documents=EXPORTS_Method_Inline_HPLC_Roesler_SeaBASS.docx	EXPORTS_2018_DATA_MASTER.xlsx
/calibration_files=EXPORTS_Method_Inline_HPLC_Roesler_SeaBASS.docx	
/data_status=final	
/missing=-9999	
/below_detection_limit=-8888	
/HPLC_lab=NASA_GSFC	
/HPLC_lab_technician=Crystal_Thomas	
/delimiter=comma	
/fields=hplc_gsfc_id	sample
/units=none	none
/end_header	

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ end ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

## 1.3 Data fields
1. Individual and summed pigments (based on SeaBASS fields/SeaHARRE reports)

2. Separate columns for any size-fractionated measurements (e.g., Tot_Chl_a_20umprefilt goes in a separate column from Tot_Chl_a)

3. Include "hplc_gsfc_id" as a column if your data were analyzed at the NASA GSFC lab to preserve the lab's sample ID

Report any replicate filters separately
Use the /below_detection_limit to mask any relevant values. It is distinct from the /missing value (e.g., /missing=-9999 vs. /below_detection_limit=-8888)
SeaBASS files may only contain data from a single cruise or deployment. If necessary, sort and separate your data by cruise then create multiple SeaBASS files
An online tool (HPLC2sb) is optionally available to help convert NASA GSFC HPLC spreadsheets into SeaBASS file format. However, please read its limitations and caveats carefully. https://seabass.gsfc.nasa.gov/hplc2sb/

# 2.0 Start Code:
## Load Libraries
```{r libraries}
librarian::shelf(
  librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  
  # additional
  hms, janitor
)

library("conflicted")

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

# load consolidated HPLC by cruise
(dir_ls(here("data", "processed", "hplc"),
       regexp = "RData") %>%
  sort(decreasing = TRUE))[1] |>
  load() 

# location to save files
loc <- 
  here("data", "processed", "hplc", glue("ind_file_{Sys.Date()}"))


```

## All SeaBass Standard Fields 
https://seabass.gsfc.nasa.gov/wiki/stdfields
```{r}
sb_field <- 
  read_tsv(here("data", "metadata", "seabass_standard_fields_all.txt"),
           show_col_types = FALSE,
           name_repair    = make_clean_names) %>%
  mutate(
    .after   = 1,
    low_name = str_to_lower(field_name),
    low_name = str_replace_all(low_name, "-", "_")
         )

# extract all field names from data and map to Seabass standard names
hplc_data <- 
  hplc_data %>% 
  mutate(
    # edit old names from previous report to match current SeaBass
    sb_name = map(
      .x = names,
      (\(x) 
            x  %>%
            mutate(
              low_name = str_replace(param_name, "(?i)t_caro", "tcar"),
              low_name = str_replace(low_name, "t_pg|t_pig", "tpg"),     
         low_name = case_when(
           str_detect(low_name, "chl_c12") ~ "chl_c1c2",
           str_detect(low_name, "ppc_tpig") ~ "ppc_tpg",
           str_detect(low_name, "t_chl_a_tpg") ~ "tchla_tpg",
           str_detect(low_name, "tchl_a") ~ str_replace(low_name, "tchl_a", "tchla"),
           str_detect(low_name, "^t_chl") ~ str_replace(low_name, "t_chl", "tchl"),
           str_detect(low_name, "t_acc") ~ str_replace(low_name, "t_acc", "tacc"),
           .default = low_name)
         ) %>%
  left_join(sb_field, by = c("low_name")) )
    )
  ) 
```
## Header Information
```{r test-default}
hd_def <- list()
hd_def$invest  <- "Frank_Muller-Karger,Enrique_Montes"

hd_def$affil     <- "University_of_South_Florida,USA"
hd_def$expri     <- "MBON"
hd_def$hplc_lab  <- "NASA_GSFC"	
hd_def$lab_tech  <- "Crystal_Thomas"	
hd_def$type      <- "pigment"
hd_def$status    <- "final" # final - not intending to revisit
hd_def$wtr_dpth  <- hd_def$stn <- "na"

hd_def$suffix <- "R1"
hd_def$fields_extr <- 
  tibble(
    field_extr = c("hplc_gsfc_id", "sample", "date","time", "station",
                   "lon","lat","depth", "water_depth","volfilt")) %>%
  left_join(sb_field, by = c("field_extr" = "field_name"))

# TODO: fill in
hd_def$contact  <- "__TODO__"
hd_def$docs     <- "__TODO__"
hd_def$cal_file <- "__TODO__"

hd_def$comments <- 
  glue(.sep = "\n",
       "!",
       "! __TODO__",
       "!")

```

```{r test-headr-skeleton}
header_skeleton <-
  glue::glue(
    "/begin_header",
    # required  
    "/investigators={hd_def$invest}",
    "/affiliations={hd_def$affil}",
    "/contact={hd_def$contact}",
    "/experiment={hd_def$expri}",
    "/cruise={cruise_id}",
    "/station={hd_def$stn}",
    "/data_file_name={file_name}", # current name of data file, self-reference
    "/documents={hd_def$docs}",    # additional info about experiment and cruise
    "/data_type={hd_def$type}",
    "/calibration_files={hd_def$cal_file}",
    "/start_date={start_date}",
    "/end_date={end_date}",
    "/start_time={start_time}[GMT]",
    "/end_time={end_time}[GMT]",
    "/north_latitude={north_latitude}[DEG]",
    "/south_latitude={south_latitude}[DEG]",
    "/east_longitude={east_longitude}[DEG]",
    "/west_longitude={west_longitude}[DEG]",
    "/water_depth={hd_def$wtr_dpth}",
    "/missing=-9999",
    "/delimiter=comma",
    
    
    # HPLC required
    "/HPLC_lab={hd_def$hplc_lab}",
    "/HPLC_lab_technician={hd_def$lab_tech}",
    "/below_detection_limit=-8888",
    
    # conditional 
    
    # optional recommended
    "/data_status={hd_def$status}",
    
    # optional
    "/original_file_name={fbase}", 
    
    "{hd_def$comments}",
    
    "/fields={fields}", # fields of data 
    "/units={pun}",  # units for each column 
    "/end_header", 
    # "{dat}",
    .sep = "\n") |>
  
  expression()
```

## Extract Header Information
```{r header-info}
hplc_w_head <-
  hplc_data %>%
  mutate(
    header_info = map(
      .x = data,
      function(x) {
        x %>%
        mutate(datetime = date + time) %>% # create datetime 
          
        # get min and max of head per cruise header info
        summarise(across(.cols = c(datetime, lon, lat), 
                         # new way using lambda notation
                         .fns = list(min = (\(x) min(x, na.rm = TRUE)),
                                     max = (\(x) max(x, na.rm = TRUE))),
                         .names = "{.col}_{.fn}")) %>%
        
        mutate(
          # split datetime to date and time separately
          start_date = format(ymd(as_date(datetime_min)),"%Y%m%d"),
          end_date   = format(ymd(as_date(datetime_max)),"%Y%m%d"),
          start_time = as_hms(datetime_min),
          end_time   = as_hms(datetime_max),
          
          # rename bound box variable names
          north_latitude = round(lat_max, 3),
          south_latitude = round(lat_min, 3),
          east_longitude = round(lon_max, 3),
          west_longitude = round(lon_min, 3),
          .keep = "unused")
        }
      )
    )
```

```{r header-info}
# cruise data header_info cruise_id 
final <-
  hplc_w_head %>%
  mutate(
     heads = pmap(
      .progress = TRUE,
      .l = list(data, header_info, cruise_id, sb_name),
      function(y, x, cruise_id, sb_name){
        
        
        
        # remove spaces in original base name 
        fbase <- 
          str_replace_all(unique(y$base), " ", "_") %>%
          str_c(collapse = ",")
        
        # create file name based on cruise ID
        file_name <-
          glue("{hd_def$expri}", "{cruise_id}", 
               "{hd_def$type}", "{x$start_date}_{hd_def$suffix}.sb", 
               .sep = "_")
        
        # fields and units standards: https://seabass.gsfc.nasa.gov/wiki/stdfields
        # SeaBass standard fields
        field_nm <- c(hd_def$fields_extr$field_extr, sb_name$field_name)
        fields <- 
          str_c(
            field_nm, 
            collapse = ",")# %T>% print()
        
        # units each field
        pun <-   
          str_c(
            c(
              hd_def$fields_extr$units,
              sb_name$units), 
            collapse = ",")# %T>% print()
 
        # evaluate header
        header <- 
          with(x, eval(header_skeleton)) #%T>% print()
        
        # readline("Ready?")
        # cat("\n---\nNEXT\n", unique(y$base), file_name,
        #     "\n---\n", sep = "\n")
        
        return(
          tibble(
            header    = header,
            file_name = file_name,
            fld_use   = list(field_nm = field_nm)
               )
          )
      }
     ),
     cols = pmap(
      list(data, heads, sb_name),
      function(.x, .y, .z) {
        select(.x, any_of(c(hd_def$fields_extr$field_extr,
                            .z$param_name))
               ) %>%
          set_names(.y$fld_use[[1]])
                 }
               )
  )
```

## Saving Files in SeaBass Format
```{r save-files}
dir_create(loc) # create dir for each day running

# save files
pwalk(list(final$cols, final$heads),
      function(x, y) {
        # write header
        cat(y$header, "\n",
            file = here(loc, y$file_name))
        
        x %>%
         mutate(
           date = format(date,"%Y%m%d"),
           across(everything(), \(x) as.character(x)), # convert to char
           across(everything(), \(x) case_when(
                                        is.na(x) ~ "-9999", # chg NA to -9999
                                        .default = x))
           ) %>%
        # write data after header
        write_delim(.,
                    delim     = ",",
                    file      = here(loc, y$file_name),
                    append    = TRUE,
                    col_names = FALSE
                    )
        }
      )
```

x  hdr = {'/begin_header';
  strcat('/received=',date_received);
  '/investigators=Frank_Muller-Karger,Enrique_Montes';
  '/affiliations=University_of_South_Florida,USA';
'/contact=emontesh@usf.edu';
'/experiment=MBON';
strcat('/cruise=',cruise);
strcat('/data_file_name=',cruise,'_',data_type);
strcat('/documents=',cruise_report);
'/calibration_files=HPLC_method_summary';
'/delimiter=space';
'/data_type=pigment';
'/data_status=final';
strcat('/start_date=',start_date);
strcat('/end_date=',end_date);
strcat('/start_time=',start_time,'[GMT]');
strcat('/end_time=',end_time,'[GMT]');
strcat('/north_latitude=',lat_n,'[DEG]');
strcat('/south_latitude=',lat_s,'[DEG]');
strcat('/west_longitude=',lon_w,'[DEG]');
strcat('/east_longitude=',lon_e,'[DEG]');
'/below_detection_limit=-8888';
'/missing=-8888';
'/water_depth=-999';
'/cloud_percent=-999';
'/wave_height=-999';
'/wind_speed=-999';
'/secchi_depth=-999';
'!';
'!RUN BY: Enrique Montes';
'!Samples were processed at NASA GSFC by Crystal Thomas';
'!Measurements below detection limit are assigned the value -9999; this represents pigments not detected';
'!as well as pigments present but with concentrations less than 0.0005?g/L.';
'!Coefficient of variation (replicate filter precision) for TChl a =	1.64%; Ppig =	3.74%';
'!!Sky: variable conditions';
'!Water: variable conditions.';
'/fields=date,station,lon,lat,depth,Tot_Chl_a,Tot_Chl_b,Tot_Chl_c,alpha-beta-Car,But-fuco,Hex-fuco,Allo,Diadino,Diato,Fuco,Perid,Zea,MV_Chl_a,DV_Chl_a,Chlide_a,MV_Chl_b,DV_Chl_b,Chl_c1c2,Chl_c3,Lut,Neo,Viola,Phytin_a,Phide_a,Pras,Gyro,TChl,PPC,PSC,PSP,Tcar,Tacc,Tpg,DP,Tacc_TChla,PSC_Tcar,PPC_Tcar,TChl_Tcar,PPC_Tpg,PSP_Tpg,TChla_Tpg';
'/units=yyyymmdd,none,degrees,degrees,m,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,mg/m^3,none,none,none,none,none,none,none';
'/end_header'};




