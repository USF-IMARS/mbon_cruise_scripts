---
title: "Sample Map"
author: "Sebastian Di Geronimo"
date: "2023-01-05"
format: html
editor: source
---

# ---- Load Libraries ----
## Load Libraries
```{r setup}
librarian::shelf(
  librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  
  # broom # optional
  
  # added
  ggrepel, ggtext, readxl, ggnewscale,
  
  # idk if needed
  fields, raster, rerddap, rgdal, ncdf4, sf, metR, cowplot,
  # datefixR
)

library("conflicted")

conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")

# scripts to download and create maps
source(here("scripts", "map_files_dwnlod.R"))

# fixes issue with reading raster file using decimal degrees
sf::sf_use_s2(FALSE)
```

## File Path and Cruise ID
```{r cruide-id-info}
# ---- Edit Cruise Info ----
cruise_id <-
  tibble(
    cruise_id   = "H23138",      # Here
    start_dates = "May 18 2023",  # Here
    end_dates   = "May 25 2023"   # Here
    ) %>%
    mutate(
      label = map2_chr(
        .x = start_dates, 
        .y = end_dates, 
        date_label
        )
    ) %T>% 
  print()

cli::cli_alert_warning(
  c("Did you make sure to update cruise info?\n\n",
  "---- Press the [Enter] key to continue! ----\n",
  "\t or go back to fix it!"))
invisible(readline())
```


```{r paths}
# paths to data location files
loc_file <- 
  here("data", "metadata") %>%
  fs::dir_ls(regexp = "^[^~]*locations.*xlsx")

# path to base map files
map_loc <- here("data", "map_shp")

# spatial extent
exnt <- c(xmin = -84, # West
          xmax = -80, # East
          ymin = 24,  # South
          ymax = 28.5 # North 
        )
```

## Load Data Locations (Lat/Lon)
```{r load-locations}
# sample
loca <-  
  loc_file %>%
  readxl::read_xlsx(sheet = 5,
                    .name_repair = janitor::make_clean_names,
                    )

# NOAA 
all_loc <- 
  loc_file %>%
  readxl::read_xlsx(sheet = 2, 
            .name_repair = janitor::make_clean_names) %>%
  filter(!(station %in% loca$station))

# zooplankton
zoo_loc <- 
  loc_file %>%
  readxl::read_xlsx(sheet = 3, 
            .name_repair = janitor::make_clean_names) 


```

## Match NOAA and IMaRS Locations
```{r data-manipulation}
# define labels for map
loc_labs <- 
  loca %>%
  group_by(station) %>%
  mutate(vals = 1) %>%
  select(-c(notes, lat, lon)) %>%
  pivot_wider(
               # id_cols = optional vector of unaffected columns,
               names_from  = c(sample_type),
               values_from = vals,
               names_sep   = "_",
               values_fn   = sum
  ) %>% 
  ungroup() %>%
  janitor::clean_names() %>%
  rowwise() %>%
  mutate(sums = sum(chl_a, hplc, cdom, e_dna, na.rm = TRUE),
         labl = case_when(
                  sums == 4 ~ "CHL, HPLC and CDOM",
                  sums == 10 ~ "CHL, HPLC, CDOM, eDNA for surf and bot",
                  sums == 6 ~ "CHL, HPLC (replicate), CDOM and eDNA",
                  sums == 5 && hplc == 2 ~ "CHL, HPLC (replicate) and CDOM",
                  sums == 5 && e_dna == 1 ~ "CHL, HPLC, CDOM, and eDNA",
                  .default = NA_character_
         )) %>%
  select(-c(chl_a:sums))


loca2 <- 
  loca %>%
  select(-notes, -sample_type) %>%
  distinct(station, .keep_all = TRUE) %>%
  right_join(., loc_labs, by = "station") %>%
  mutate(
    lon = if_else(station == 58, -81.65333333, lon),
    lat = if_else(station == 58, 25.16666667, lat),
    lon = if_else(station == 68, -81.16666667, lon),
    lat = if_else(station == 68, 24.93, lat)
  )
```

## Additional noaa locations starting Feb 2023
```{r noaa-loc}
noaa_loc <-
  loc_file %>%
  read_xlsx(sheet = 4, 
            .name_repair = janitor::make_clean_names)  %>%
  rename("station" = waypoint) %>%
  unite(col = "lat", 2:4, sep = " ") %>%
  unite(col = "lon", 3:5, sep = " ") %>%
  mutate(
    station = case_when(
                        str_detect(station, "MR") ~ "MR",
                        str_detect(station, "21/ LK") ~ "LK",
                        str_detect(station, "WS") ~ "WS",
                        TRUE ~ station
                        ),
    lon = parzer::parse_lon(lon),
    lat = parzer::parse_lat(lat), 
    .before = 2
    ) %>%
  filter(!(station %in% loca2$station))
  

loca2[loca2$station %in% noaa_loc$station,]
noaa_loc[!(noaa_loc$station %in% loca2$station),]$station

# addtional locations ----
# add_loc <- paste("BG7", "CW7", "ROME5", sep = "|")

# noaa_loc_add <- 
#   noaa_loc %>%
#   filter(str_detect(waypoint, add_loc)) %>%
#   
#   mutate(
#     
#     station = waypoint,
#     labl = "CHL, HPLC, CDOM, and eDNA",
#    
#     
#     ) 
# 
# loca2 <- loca2 %>% 
#   bind_rows(noaa_loc_add)
  
```

# ---- Base Map Data ----

Topography, ETOPO1, 0.0166667 degrees, Global (longitude -180 to 180), (Ice Sheet Surface) from https://coastwatch.pfeg.noaa.gov/erddap/griddap/

Global Self-consistent, Hierarchical, High-resolution Geography Database (GSHHG) from https://www.ngdc.noaa.gov/mgg/shorelines/

```{r download-map}
# download topography (.nc) and coastline (.shp)
world_download(
  path_land  = map_loc,
  path_topo  = map_loc,
  extent     = exnt,
  use_suffix = NULL
)
```

## Load Base Maps for Plotting 
```{r load-map-files}
# select and read coastline file from GSHHS then crop
# load maps
map_obj <-
  load_map_obj(
    .map_coast = map_loc,
    .map_state = NULL,
    .map_bath  = map_loc,
    .map_file  = "etopo1.nc",
    .extent    = exnt
  )
```

## Plot Base Map
```{r base-map}
base_plt <- 
base_map_plot(map_obj$coast_topo, .bathy = NULL, exnt)
base_plt
```

# ---- Plot Locations ----
```{r add-stations, fig.width=8.5, fig.height=11}
set.seed(123)
imars_map <-
  base_plt +
  # ---- Cruise ID
  annotate(
    geom        = "richtext", 
    x           = -81.5,
    y           = 28,
    # label       = glue("{cruise_id[[1]]} (IMaRS)"),
    label       = glue("{cruise_id$cruise_id[1]} (IMaRS)"),
    size        = 10,
    fontface    = "bold",
    fill        = NA,
    label.color = NA,
  ) +
  # ---- Cruise Dates
  annotate(
    geom        = "richtext", 
    x           = -81.5,
    y           = 27.85, 
    # label       = cruise_id[[2]],
    label       = cruise_id$label[1],
    size        = 7,
    fontface    = "bold",
    fill        = NA,
    label.color = NA
  ) +
  # ---- NOAA Locations
  geom_point(
    data  = noaa_loc,
    aes(x = lon, 
        y = lat),
    shape = 3,
    color = "gray",
    size  = 1
  ) +
  # I may want to add labels for all none sampled locations
  # geom_text_repel(data = all_loc, aes(x = lon, y = lat, label = station),
  #                size = 2,
  #                # hjust = -1,
  #                color = "gray"
  #                # vjust = 1
  #                ) +
  # ---- Sample Locations
  geom_point(
    data = loca2,
    aes(x = lon, 
        y = lat, 
        color = labl),
  ) +
  geom_text_repel(
    aes(x = lon, 
        y = lat, 
        label = station),
    data  = loca2,
    size  = 2.5,
    hjust = 0,
  ) +

  scale_color_manual(
    name   = "Samples",
    values = c("#FF7F24", "#EE3B3B", "#00FF00", "#1E90FF", "#BA55D3")
  ) +
  labs(color = NULL) +

  # ---- Zooplankton
  new_scale_color() +
  geom_point(
    data  = zoo_loc,
    aes(
      x = lon,
      y = lat,
      color = labs
    ),
    shape = 5,
    size  = 2
  ) +
  labs(color = "Zooplankton Mesh Size") +
  theme(
    legend.position = c(0.2, 0.14),
    legend.text     = element_text(size = 10),
    legend.title    = element_text(size = 15)
  )
imars_map
```
## Save Map
```{r save-map, fig.width=8.5, fig.height=11}
sv_arg <-
  list(
    save_path = here("data", "metadata", "cruise_map")
  ) %>%
  c(
    file_name =
      here(
        "data", "metadata", "cruise_map",
        glue("{cruise_id[[1]]}_imars_sample_locations.jpeg")
      )
  )

if (!file_exists(sv_arg$file_name) || FALSE) {
  # create directory if doens't exist
  fs::dir_create(sv_arg$save_path)
  
  # save map
  ggsave(
   sv_arg$file_name,
   plot   = imars_map,
   dpi    = 900,
   width  = 8.5,
   height = 11
  )
} 

rm(sv_arg)
```
